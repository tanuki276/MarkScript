<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>MarkScript Viewer — 拡張版</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; object-src 'none'; base-uri 'self';">
<style>
  /* --- ベーススタイル (Tailwind風の現代的なデザイン) --- */
  body { 
    font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
    background: #f0f4f8; 
    padding: 20px; 
    color: #1f2937; 
    transition: background-color .25s, color .25s; 
    min-height: 100vh;
  }
  h1 { font-size: 2.25rem; font-weight: 700; color: #111827; margin-bottom: 1rem; }
  h3 { font-size: 1.5rem; font-weight: 600; color: #374151; margin-top: 1.5rem; }
  textarea { 
    width: 100%; 
    max-width: 800px; 
    height: 250px; 
    padding: 12px; 
    border-radius: 10px; 
    border: 1px solid #d1d5db; 
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); 
    font-size: 14px; 
    resize: vertical; 
    background: white; 
    color: #1f2937; 
  }

  /* コントロールパネル */
  .controls { 
    max-width: 800px; 
    display: flex; 
    flex-wrap: wrap; 
    gap: 12px; 
    margin-top: 15px; 
  }
  .controls input[type="text"] { 
    flex-grow: 1; 
    padding: 10px; 
    border-radius: 8px; 
    border: 1px solid #d1d5db; 
    min-width: 200px;
  }
  .controls button { 
    padding: 10px 20px; 
    font-size: 14px; 
    border: none; 
    background: #4f46e5; 
    color: white; 
    border-radius: 8px; 
    cursor: pointer; 
    white-space: nowrap; 
    transition: background-color 0.2s;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
  }
  .controls button:hover { background: #4338ca; }
  .controls button:disabled { opacity:.5; cursor:not-allowed; }

  /* プレビューエリア */
  #output { 
    background: white; 
    border: 1px solid #e5e7eb; 
    padding: 20px; 
    margin-top: 25px; 
    max-width: 800px; 
    border-radius: 12px; 
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
    min-height: 100px;
  }
  
  /* インライン要素の修正のために追加: <p>タグ内のインライン要素が親の行に収まるように */
  #output p { margin: 0 0 1em 0; line-height: 1.6; }
  #output p:last-child { margin-bottom: 0; }


  /* マニュアル */
  #manual { 
    background: #eef2ff; 
    padding: 15px; 
    border-left: 5px solid #6366f1; 
    margin-bottom: 20px; 
    max-width: 800px; 
    border-radius: 8px; 
    font-size: 0.9em; 
    line-height: 1.6;
  }
  #manual hr { margin: 8px 0; border-top: 1px solid #ddd; }

  /* ダークモードトグル */
  #modeToggle { 
    position:fixed; 
    top:20px; 
    right:20px; 
    background:#1f2937; 
    color:#fff; 
    border-radius:50px; 
    padding:8px 15px; 
    font-weight:600; 
    cursor:pointer; 
    z-index:1000;
  }

  /* コピーボックス */
  .copy-box { 
    background: #f3f4f6; 
    padding: 10px; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin: 10px 0; 
    border-radius: 6px; 
    border: 1px solid #e5e7eb;
  }
  .copy-box button { margin-left:10px; padding:6px 12px; font-size:12px; border-radius: 6px; background: #6366f1; }
  .copy-box span { font-family: monospace; word-break: break-all; color: #374151; }

  /* 小文字 */
  .small-text { font-size: 0.85rem; color: #6b7280; margin-bottom: 0.5rem; }

  /* 枠文字のプレビュー用スタイル (インライン要素として機能させる) */
  .colored-text, .bordered-text {
    padding: 2px 4px; 
    border-radius: 4px;
    margin: 0 2px;
  }

  .bordered-text { 
    border: 2px solid; 
    display: inline-block; /* インラインブロックにして枠線の見た目を保つ */
    padding: 5px 10px;
  }

  /* 画像引用のプレビュー用スタイル */
  #output img { max-width: 100%; height: auto; display: block; margin: 15px auto; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
  #output figure { margin: 0; }
  #output figcaption { font-size: 0.8em; color: #6b7280; text-align: center; margin-top: 5px; }

  /* ダークモードスタイル */
  body.dark { background:#1f2937; color:#e5e7eb; }
  body.dark textarea { background:#374151; color:#f3f4f6; border-color:#4b5563; }
  body.dark #output { background:#374151; border-color:#4b5563; box-shadow: none; }
  body.dark #manual { background: #111827; border-color: #6366f1; color: #f3f4f6; }
  body.dark .copy-box { background: #4b5563; border-color: #6b7280; }
  body.dark .copy-box span { color: #f3f4f6; }
  body.dark h1 { color: #f3f4f6; }
  body.dark h3 { color: #d1d5db; }
  body.dark .small-text { color: #9ca3af; }
  body.dark #modeToggle { background: #f3f4f6; color: #1f2937; }

  @media (max-width:640px) { 
    body { padding: 10px; }
    #modeToggle { top: 10px; right: 10px; padding: 6px 12px; }
    .controls input[type="text"] { min-width: 100%; order: 3; }
    .controls button:first-child { order: 1; }
    .controls button:nth-child(2) { order: 2; }
    .controls button:last-child { order: 4; flex-basis: 100%; }
  }
</style>
</head>
<body>
<h1>MarkScript Viewer — 拡張版</h1>

<div id="manual">
  <strong>■ MarkScript（拡張機能）：</strong><br />
  ・<code>タイトル </code>：大見出し（h1）<br />
  ・<code>大 </code>：中見出し（h3）<br />
  ・**<code>小 テキスト</code>**：文字を小さく表示<br />
  ・**<code>コピー テキスト</code>**：コピーボタン付きのテキスト<br />
  ・<code>埋め URL テキスト</code>：リンク (インライン、http/https のみ)<br />
  <hr>
  ・**<code>背景 (色名/HEX)</code>**：コンテンツの背景色を設定（最初の行のみ有効）<br />
  ・**<code>色付 (色名/HEX) テキスト</code>**：テキストに色付け (**インライン**) <br />
  ・**<code>枠文字 (色名/HEX) テキスト</code>**：文字の周りに枠線を付ける (**インライン**) <br />
  ・**<code>引用 URL</code>**：画像を引用表示<br />
  ・**<code>改行</code>**：強制改行 (<code>&lt;br&gt;</code>) <br />
  ・空行：改行 (<code>&lt;br&gt;</code>) <br />
  ・その他：通常の段落
</div>

<textarea id="input" placeholder="ここにMarkScriptを書いてください"></textarea>

<div class="controls">
    <button id="run">変換してプレビュー</button>
    <button id="contactBtn">お問い合わせ</button>

    <input type="text" id="publishPath" placeholder="公開パス (例: mypage.html。site/フォルダに作成)">
    <button id="publishBtn">自動公開を実行</button>
</div>

<div id="output" aria-live="polite"></div>

<div id="modeToggle" role="button" aria-pressed="false">ダークモード</div>

<script>
(function(){
  'use strict';

  // --- 設定/制限 ---
  const CONFIG = {
    MAX_INPUT_CHARS: 20000,
    MAX_LINE_CHARS: 2000,
    MAX_LINES: 2000,
    SUBMIT_WINDOW_MS: 60_000,
    MAX_SUBMITS_PER_WINDOW: 15,
    COOLDOWN_MS: 800,
    ALLOWED_URL_PROTOCOLS: ['http:', 'https:'],
    RATE_LIMIT_MESSAGE: '短時間に処理が集中しています。しばらく待ってから再度実行してください。',
    GENERIC_ERROR_MESSAGE: '[エラーが発生しました。入力形式を確認してください。]',
  };

  // サーバーサイドと同期済みのカラーマップ
  const COLOR_MAP = {
      '赤': 'red',
      '青': 'blue',
      '緑': 'green',
      '黄': 'yellow',
      '黒': 'black',
      '白': 'white',
      '灰': 'gray', 
      '紫': 'purple',
      'オレンジ': 'orange',
  };

  const submitTimestamps = [];
  let lastClick = 0;

  const inputEl = document.getElementById('input');
  const runBtn = document.getElementById('run');
  const outputEl = document.getElementById('output');
  const contactBtn = document.getElementById('contactBtn');
  const publishBtn = document.getElementById('publishBtn');
  const publishPathEl = document.getElementById('publishPath');
  const modeToggle = document.getElementById('modeToggle');

  // --- ユーティリティ関数群 ---

  function appendTextNode(parent, text) {
    parent.appendChild(document.createTextNode(text));
  }

  function createMessage(text, color = 'red', isError = false) {
    const p = document.createElement('p');
    p.style.color = color;
    p.style.fontStyle = 'italic';
    if (isError) {
        p.style.fontWeight = 'bold';
        p.style.padding = '5px';
        p.style.backgroundColor = 'rgba(255, 0, 0, 0.1)';
        p.style.borderRadius = '5px';
    }
    appendTextNode(p, text);
    return p;
  }

  function validateAndNormalizeUrl(raw) {
    try {
      const cleaned = raw.trim();
      if (/\s/.test(cleaned) || /[<>"'`]/.test(cleaned)) return null; 

      const url = new URL(cleaned, location.href);
      if (!CONFIG.ALLOWED_URL_PROTOCOLS.includes(url.protocol)) return null;
      if (url.username || url.password || url.port) return null;
      if (url.href.length > 2048) return null;
      if (url.pathname.includes('..')) return null; 

      return url.href;
    } catch (e) {
      return null;
    }
  }

  function normalizeColor(input) {
      if (!input) return null;
      const lower = input.toLowerCase();
      if (COLOR_MAP[input]) return COLOR_MAP[input];
      if (/^#([0-9A-F]{3}){1,2}$/i.test(input)) return input;
      if (/^rgba?\((.+?)\)$/i.test(lower) || /^hsla?\((.+?)\)$/i.test(lower)) return input;
      if (/^[a-z]+$/.test(lower)) return lower;
      return null;
  }

  async function writeToClipboard(text) {
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
          return true;
        }
      } catch (e) { /* fall through */ }
      try {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed'; ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        const ok = document.execCommand('copy');
        document.body.removeChild(ta);
        return !!ok;
      } catch (e) {
        return false;
      }
  }

  function createCopyBox(text) {
    const div = document.createElement('div');
    div.className = 'copy-box';

    const span = document.createElement('span');
    appendTextNode(span, text);
    
    const button = document.createElement('button');
    appendTextNode(button, 'コピー');
    
    button.addEventListener('click', async () => {
        const success = await writeToClipboard(text);
        button.textContent = success ? 'コピー完了!' : '失敗';
        setTimeout(() => button.textContent = 'コピー', 1500);
    });

    div.appendChild(span);
    div.appendChild(button);
    return div;
  }

  function createParagraph(text) {
    const p = document.createElement('p');
    appendTextNode(p, text);
    return p;
  }

  // --- MarkScriptパーサーのためのヘルパー関数（インライン機能修正版） ---

  /**
   * インラインディレクティブ（色付, 枠文字, 埋め）をHTML文字列に変換する
   * @param {string} text - 処理するテキスト行
   * @returns {string} HTML文字列に置換されたテキスト
   */
  function parseLineForInlines(text) {
    let result = text;
    
    // 1. 埋め (リンク) の処理
    result = result.replace(/埋め\s+(https?:\/\/[^\s]+)(?:\s+(.*?))?(?=\s*埋め|\s*色付|\s*枠文字|$)/g, (match, url, linkText) => {
        const safeUrl = validateAndNormalizeUrl(url);
        const display = (linkText || url || '').trim();

        if (safeUrl) {
            return `<a href="${safeUrl}" target="_blank" rel="noopener noreferrer">${display}</a>`;
        }
        return `[無効なURL: ${url}]`; 
    });

    // 2. 色付 / 枠文字 の処理
    const inlineRegex = /(色付|枠文字)\s*\(([^)]+)\)\s*(.*?)(?=(?:色付|枠文字|埋め|\s*$))/g;

    result = result.replace(inlineRegex, (match, type, rawColor, content) => {
        const color = normalizeColor(rawColor.trim());
        const contentTrimmed = content.trim();

        if (!color) return `[無効な色: ${rawColor}]`; 

        const isBorder = (type === '枠文字');
        let style = '';
        let className = '';

        if (isBorder) {
            className = 'bordered-text';
            style = `border-color: ${color}; color: ${color};`;
        } else {
            className = 'colored-text';
            style = `color: ${color};`;
        }

        return `<span class="${className}" style="${style}">${contentTrimmed}</span>`;
    });

    return result;
  }

  // --- MarkScriptパーサー（全体のリファクタリング版） ---

  function parseMarkScriptToNodes(text) {
    const nodes = document.createDocumentFragment();
    const lines = text.split(/\r?\n/).slice(0, CONFIG.MAX_LINES);
    let isFirstLine = true; 

    for (let i = 0; i < lines.length; i++) {
      let line = lines[i];
      if (line == null) line = '';
      if (line.length > CONFIG.MAX_LINE_CHARS) {
        line = line.slice(0, CONFIG.MAX_LINE_CHARS) + '…';
      }

      const lineTrimmed = line.trim();
      let consumed = false;

      // 1. 背景 (BG色設定)
      if (isFirstLine && line.startsWith('背景 ')) {
          const color = line.slice(3).trim().split(/\s+/)[0];
          const validColor = normalizeColor(color);
          nodes.appendChild(createMessage(`[設定行] 背景色が "${validColor || color}" に設定されました (プレビュー無効)`, 'gray'));
          isFirstLine = false;
          consumed = true;
      }
      isFirstLine = false;
      if (consumed) continue;

      // 2. タイトル
      if (line.startsWith('タイトル ')) {
        const h1 = document.createElement('h1');
        appendTextNode(h1, line.slice(4).trim());
        nodes.appendChild(h1);
        consumed = true;
      }

      // 3. 大
      else if (line.startsWith('大 ')) {
        const h3 = document.createElement('h3');
        appendTextNode(h3, line.slice(2).trim());
        nodes.appendChild(h3);
        consumed = true;
      }

      // 4. 小 (文字を小さくする)
      else if (line.startsWith('小 ')) {
        const p = document.createElement('p');
        p.className = 'small-text';
        appendTextNode(p, line.slice(2).trim());
        nodes.appendChild(p);
        consumed = true;
      }

      // 5. コピー (コピーボタン付き)
      else if (line.startsWith('コピー ')) {
        nodes.appendChild(createCopyBox(line.slice(4).trim()));
        consumed = true;
      }

      // 6. 引用 (画像)
      else if (line.startsWith('引用 ')) {
        const rawUrl = line.slice(3).trim().split(/\s+/)[0];
        const safe = validateAndNormalizeUrl(rawUrl);
        if (safe) {
            const figure = document.createElement('figure');
            const img = document.createElement('img');
            img.src = safe;
            img.alt = `画像引用: ${safe}`; 
            const caption = document.createElement('figcaption');
            appendTextNode(caption, safe);
            figure.appendChild(img);
            figure.appendChild(caption);
            nodes.appendChild(figure);
        } else {
            nodes.appendChild(createMessage(`[無効な画像URL: ${rawUrl}]`, 'red', true));
        }
        consumed = true;
      }

      // 7. 改行コマンド <br>
      else if (line.startsWith('改行')) {
          nodes.appendChild(document.createElement('br'));
          consumed = true;
      }

      // 8. 空行: 改行 <br> (既存の動作維持)
      else if (lineTrimmed === '') {
        nodes.appendChild(document.createElement('br'));
        consumed = true;
      }

      // 9. その他: 通常の段落 <p> (インライン処理を適用)
      if (!consumed) {
        // インラインディレクティブ (色付, 枠文字, 埋め) をHTMLに変換
        const htmlContent = parseLineForInlines(line); 

        // 結果のHTML文字列を安全にDOMノードに変換して段落に追加
        const p = document.createElement('p');
        p.innerHTML = htmlContent; 
        nodes.appendChild(p);
      }
    }
    return nodes;
  }

  // --- イベントハンドラ ---

  function checkRateLimit() {
    const now = Date.now();
    while (submitTimestamps.length && (now - submitTimestamps[0]) > CONFIG.SUBMIT_WINDOW_MS) {
      submitTimestamps.shift();
    }
    if (submitTimestamps.length >= CONFIG.MAX_SUBMITS_PER_WINDOW) {
      alert(CONFIG.RATE_LIMIT_MESSAGE);
      return false;
    }
    submitTimestamps.push(now);
    return true;
  }

  // プレビュー実行
  runBtn.addEventListener('click', (ev) => {
    const now = Date.now();
    if (now - lastClick < CONFIG.COOLDOWN_MS) return; 
    lastClick = now;

    if (!checkRateLimit()) return;

    const input = inputEl.value || '';
    if (input.length > CONFIG.MAX_INPUT_CHARS) {
      alert('入力が大きすぎます（最大 ' + CONFIG.MAX_INPUT_CHARS + ' 文字）。');
      return;
    }

    // 以前の出力内容をクリア
    while (outputEl.firstChild) {
      outputEl.removeChild(outputEl.firstChild);
    }
    
    try {
      const fragment = parseMarkScriptToNodes(input);
      outputEl.appendChild(fragment);
    } catch (e) {
      console.error(e);
      outputEl.appendChild(createMessage(CONFIG.GENERIC_ERROR_MESSAGE, 'red', true));
    }
  });

  // 自動公開実行 (パス検証と /site フォルダ限定のロジック)
  publishBtn.addEventListener('click', async () => {
    const markscript = inputEl.value;
    let path = publishPathEl.value.trim();

    if (!markscript || markscript.length > CONFIG.MAX_INPUT_CHARS) {
        alert('公開する内容が無効または大きすぎます。');
        return;
    }

    if (!path) {
        alert('公開パスを入力してください。');
        return;
    }

    // ⚠️ クライアント側のパス検証 (サーバー側で厳格に再検証されます)
    // ユーザーが 'mypage.html' のようにファイル名だけを入力した場合に対応
    if (!path.includes('/')) {
        path = 'site/' + path;
    } else {
        path = path.replace(/^\/+/, ''); 
        if (!path.startsWith('site/')) {
            alert('公開は /site フォルダ内に限定されています。有効なパスを入力してください (例: mypage.html または site/mypage.html)。');
            return;
        }
    }

    // 有効なファイルパス形式のチェック（必須: .html、../ 禁止を簡易チェック）
    if (!path.endsWith('.html') || path.includes('..')) {
        alert('無効なファイルパスです。ファイルパスは .html で終わる必要があり、".."(上位ディレクトリ)へのアクセスは禁止されています。');
        return;
    }
    
    if (!checkRateLimit()) return;

    publishBtn.disabled = true;
    publishBtn.textContent = '公開中...';

    try {
        const response = await fetch('/api/deploy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                markscript: markscript,
                filepath: path 
            })
        });

        const result = await response.json();

        if (response.ok) {
            alert('公開成功！新しいサイトのURL: ' + result.publishedUrl);
        } else {
            alert('公開エラー: ' + (result.error || '不明なエラーが発生しました。') + (result.details ? ` (${result.details.message || result.details})` : ''));
        }
    } catch (e) {
        console.error('Fetch Error:', e);
        alert('通信エラーが発生しました。');
    } finally {
        publishBtn.disabled = false;
        publishBtn.textContent = '自動公開を実行';
    }
  });


  // --- 初期化/UIロジック ---
  function setupModeToggle() {
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
        modeToggle.textContent = 'ライトモード';
        modeToggle.setAttribute('aria-pressed', 'true');
    }
  }

  contactBtn.addEventListener('click', () => {
    window.open('https://discord.gg/vq6pqgXj', '_blank', 'noopener');
  });

  modeToggle.addEventListener('click', () => {
    const isDark = document.body.classList.toggle('dark');
    modeToggle.textContent = isDark ? 'ライトモード' : 'ダークモード';
    modeToggle.setAttribute('aria-pressed', String(isDark));
  });

  inputEl.addEventListener('keydown', (ev) => {
    if ((ev.ctrlKey || ev.metaKey) && ev.key === 'Enter') {
      ev.preventDefault();
      runBtn.click();
    }
  });

  setupModeToggle();

})();
</script>
</body>
</html>
